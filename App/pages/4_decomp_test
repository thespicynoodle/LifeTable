import streamlit as st
import os
from dotenv import load_dotenv
import pandas as pd
from supabase import create_client, Client

load_dotenv()

# Supabase credentials
url = os.getenv("PROJECT_URL")
key = os.getenv("SECRET_PROJECT_API_KEY")

# Initialize Supabase client
supabase: Client = create_client(url, key)

def load_data():
    """Fetch data from Supabase table 'LifeTables' with pagination"""
    data_list = []
    start_row = 0
    batch_size = 1000

    while True:
        response = supabase.table('PopulationData').select("*").range(start_row, start_row + batch_size - 1).execute()
        batch_data = response.data
        
        if not batch_data:
            break
        
        data_list.extend(batch_data)
        start_row += batch_size
    
    return pd.DataFrame(data_list)

def calculate_life_expectancy_contribution(life_table_1, life_table_2):
    """Calculate the contribution of each age group to life expectancy difference between two years."""
    # Ensure that the dataframes are aligned on age groups
    if not (life_table_1['Age'].equals(life_table_2['Age'])):
        raise ValueError("Age groups in the two life tables must match")

    # Initialize a list to store the contributions
    contributions = []

    # Iterate over age groups
    for i in range(len(life_table_1)):
        if i == len(life_table_1) - 1:  # Last age group
            delta_x = (life_table_2.loc[i, 'lx'] / life_table_1.loc[i, 'lx']) * \
                      (life_table_2.loc[i, 'Tx'] / life_table_2.loc[i, 'lx'] - \
                       life_table_1.loc[i, 'Tx'] / life_table_1.loc[i, 'lx'])
        else:  # For other age groups
            delta_x = life_table_2.loc[i, 'n'] * \
                      ((life_table_2.loc[i, 'lx'] / life_table_1.loc[i, 'lx']) * \
                       (life_table_2.loc[i, 'Lx'] / life_table_2.loc[i, 'lx'] - \
                        life_table_1.loc[i, 'Lx'] / life_table_1.loc[i, 'lx']))
        
        contributions.append(delta_x)

    return pd.DataFrame({
        'Age': life_table_1['Age'],
        'Contribution to LE difference (years)': contributions
    })


# Button for calculating the decomposition between two years
if st.button('Calculate Life Expectancy Difference Decomposition'):
    if len(selected_years) == 2:
        # Filter data for the selected country, gender, and years
        filtered_df_1 = df[
            (df['year'] == selected_years[0]) &
            (df['location_name'] == selected_country) &
            (df['sex_name'] == selected_gender)
        ]
        filtered_df_2 = df[
            (df['year'] == selected_years[1]) &
            (df['location_name'] == selected_country) &
            (df['sex_name'] == selected_gender)
        ]

        # Calculate life tables for both years
        life_table_1 = calculate_life_table(filtered_df_1['total_deaths'].tolist(), filtered_df_1['population'].tolist())
        life_table_2 = calculate_life_table(filtered_df_2['total_deaths'].tolist(), filtered_df_2['population'].tolist())

        # Calculate the contribution to the life expectancy difference
        le_contributions = calculate_life_expectancy_contribution(life_table_1, life_table_2)

        # Display the decomposition results
        st.write(f"Life Expectancy Contribution by Age Group ({selected_years[0]} vs {selected_years[1]})")
        st.dataframe(le_contributions)
    else:
        st.write("Please select exactly two years for decomposition.")

